// SPAC OS Database Schema
// PostgreSQL with Prisma ORM
// Sprint 2 - Full Models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum SpacStatus {
  PRE_IPO
  SEARCHING
  LOI_SIGNED
  DA_ANNOUNCED
  SEC_REVIEW
  SHAREHOLDER_VOTE
  CLOSING
  COMPLETED
  LIQUIDATING
  LIQUIDATED
  TERMINATED
  // Legacy values for compatibility
  DEFINITIVE_AGREEMENT
  VOTE_PENDING
  DE_SPAC_COMPLETE
}

enum SpacPhase {
  PRE_IPO
  IPO
  TARGET_SEARCH
  LOI
  DUE_DILIGENCE
  DA_NEGOTIATION
  SEC_REVIEW
  PROXY
  VOTE
  CLOSING
  POST_CLOSE
  LIQUIDATION
}

enum TargetStatus {
  IDENTIFIED
  PRELIMINARY
  INITIAL_OUTREACH
  NDA_SIGNED
  DUE_DILIGENCE
  TERM_SHEET
  LOI
  LOI_SUBMITTED
  DEFINITIVE
  NEGOTIATION
  CLOSED
  PASSED
  REJECTED
  TERMINATED
  CLOSED_WON
}

enum TargetStage {
  SOURCING
  SCREENING
  PRELIMINARY_DD
  FULL_DD
  NEGOTIATION
  DOCUMENTATION
  CLOSING
}

enum DocumentType {
  NDA
  LOI
  DEFINITIVE_AGREEMENT
  FINANCIAL_STATEMENT
  DUE_DILIGENCE
  BOARD_PRESENTATION
  SEC_FILING
  INVESTOR_PRESENTATION
  PRESS_RELEASE
  LEGAL
  TAX
  INSURANCE
  ENVIRONMENTAL
  TECHNICAL
  OTHER
}

enum DocumentStatus {
  DRAFT
  PENDING_REVIEW
  IN_REVIEW
  APPROVED
  REJECTED
  FINAL
  ARCHIVED
}

// SecFilingStatus enum removed - SecFiling model deprecated in Sprint 12.5

enum FilingType {
  S1
  S4
  F1
  F4
  DEFA14A
  DEFM14A
  PRER14A
  PREM14A
  SC_TO
  FORM_8K
  FORM_10K
  FORM_10Q
  FORM_425
  SUPER_8K
  REGISTRATION
  PROXY
  PROSPECTUS
  OTHER
}

enum FilingStatus {
  DRAFTING
  INTERNAL_REVIEW
  LEGAL_REVIEW
  BOARD_APPROVAL
  FILED
  SEC_COMMENT
  RESPONSE_FILED
  AMENDED
  EFFECTIVE
  WITHDRAWN
}

enum ContactType {
  INVESTOR
  ADVISOR
  LEGAL
  BANKER
  TARGET_EXEC
  BOARD_MEMBER
  SPONSOR
  UNDERWRITER
  AUDITOR
  OTHER
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum FinancialType {
  TRUST_ACCOUNT
  CAP_TABLE
  DILUTION_MODEL
  PRO_FORMA
  FORECAST
}

enum ComplianceStatus {
  PENDING
  IN_PROGRESS
  COMPLIANT
  NON_COMPLIANT
  WAIVED
  EXPIRED
}

enum WarrantType {
  PUBLIC
  PRIVATE
  WORKING_CAPITAL
  FORWARD_PURCHASE
}

enum PipeStatus {
  PROSPECT
  CONTACTED
  INTERESTED
  TERM_SHEET
  COMMITTED
  FUNDED
  DECLINED
}

enum EarnoutStatus {
  PENDING
  TRACKING
  ACHIEVED
  MISSED
  EXPIRED
}

enum ConflictSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Sprint 8 - CRM Enums
enum ContactStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
  PROSPECT
  LEAD
}

enum InteractionType {
  EMAIL
  CALL
  MEETING
  NOTE
  TASK
  LINKEDIN
  OTHER
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum TradingWindowStatus {
  OPEN
  CLOSED
  BLACKOUT
}

enum MilestoneType {
  REGULATORY
  FINANCIAL
  LEGAL
  OPERATIONAL
  STRATEGIC
  OTHER
}

enum SponsorTier {
  TIER_1
  TIER_2
  TIER_3
  EMERGING
}

// Sprint 10 - PE Firm Management Enums
enum OrganizationType {
  PE_FIRM
  IB
  TARGET_COMPANY
  SERVICE_PROVIDER
  LAW_FIRM
  ACCOUNTING_FIRM
  CONSULTING_FIRM
  GENERAL           // General company (contacts' employers, etc.)
  OTHER
}

// Sprint 12.5 - Status field enums (replacing string fields)
enum MeetingAttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum BoardMeetingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum FilingWorkflowStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum FilingReviewerStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum OrganizationSubType {
  // PE sub-types
  BUYOUT
  GROWTH_EQUITY
  VENTURE_CAPITAL
  FAMILY_OFFICE
  SOVEREIGN_WEALTH
  HEDGE_FUND
  // IB sub-types
  BULGE_BRACKET
  MIDDLE_MARKET
  BOUTIQUE
  REGIONAL
}

enum StakeType {
  MAJORITY
  MINORITY
  CONTROL
  GROWTH_EQUITY
  CO_INVEST
}

enum ExitStatus {
  ACTIVE
  PARTIALLY_EXITED
  FULLY_EXITED
  WRITTEN_OFF
}

enum SeniorityLevel {
  C_LEVEL
  PARTNER
  MANAGING_DIRECTOR
  VP
  DIRECTOR
  ASSOCIATE
  ANALYST
}

enum RelationshipStrength {
  COLD
  WARM
  HOT
  ADVOCATE
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  MEETING_SCHEDULED
  MEETING_COMPLETED
  CALL_MADE
  CALL_RECEIVED
  NOTE_ADDED
  DEAL_DISCUSSED
  DOCUMENT_SHARED
  CONTACT_ADDED
  RELATIONSHIP_UPDATED
}

// ============================================================================
// MODELS
// ============================================================================

/// User - System user (synced from Clerk)
model User {
  id        String  @id @default(cuid())
  clerkId   String? @unique
  email     String  @unique
  name      String?
  image     String?
  firstName String?
  lastName  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedTasks         Task[]                 @relation("TaskAssignee")
  createdTasks          Task[]                 @relation("TaskCreator")
  insiderTradingWindows InsiderTradingWindow[]
  comments              Comment[]
  auditLogs             AuditLog[]             @relation("UserAuditLogs")

  // Sprint 8 - CRM Relations
  ownedContacts      Contact[]           @relation("ContactOwner")
  createdInteractions Interaction[]      @relation("InteractionCreator")
  createdContactNotes ContactNote[]      @relation("ContactNoteCreator")
  createdMeetings    Meeting[]           @relation("MeetingCreator")
  meetingAttendances MeetingAttendee[]   @relation("MeetingAttendees")
  calendarConnection CalendarConnection?
  emailConnection    EmailConnection?

  // Sprint 10 - Activity Feed
  activities ActivityFeed[]

  @@index([clerkId])
  @@index([email])
  @@map("users")
}

/// Sponsor - SPAC Sponsor entity
model Sponsor {
  id          String      @id @default(cuid())
  name        String
  tier        SponsorTier @default(TIER_2)
  description String?     @db.Text
  website     String?
  logoUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacs SpacSponsor[]

  @@map("sponsors")
}

/// SpacSponsor - Many-to-many relationship between SPACs and Sponsors
model SpacSponsor {
  id           String   @id @default(cuid())
  isPrimary    Boolean  @default(false)
  ownershipPct Decimal? @db.Decimal(5, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId    String
  spac      Spac    @relation(fields: [spacId], references: [id], onDelete: Cascade)
  sponsorId String
  sponsor   Sponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@unique([spacId, sponsorId])
  @@index([spacId])
  @@index([sponsorId])
  @@map("spac_sponsors")
}

/// SPAC entity - Represents a Special Purpose Acquisition Company
model Spac {
  id          String     @id @default(cuid())
  name        String
  ticker      String?    @unique
  cik         String?
  status      SpacStatus @default(SEARCHING)
  phase       SpacPhase  @default(TARGET_SEARCH)
  description String?    @db.Text

  // Financial
  trustAmount       Decimal? @db.Decimal(18, 2)
  ipoSize           Decimal? @db.Decimal(18, 2)
  trustBalance      Decimal? @db.Decimal(18, 2)
  sharesOutstanding BigInt?

  // Key Dates
  ipoDate           DateTime?
  deadlineDate      DateTime?      // SPAC deadline for completing business combination
  extensionDeadline DateTime?
  daAnnouncedDate   DateTime?
  proxyFiledDate    DateTime?
  voteDate          DateTime?
  closingDate       DateTime?

  // Extensions
  maxExtensions  Int @default(2)
  extensionsUsed Int @default(0)
  extensionCount Int @default(0)

  // Redemption
  redemptionRate Decimal? @db.Decimal(5, 4)

  // Target criteria
  targetSectors     String[] @default([])
  targetGeographies String[] @default([])
  tags              String[] @default([])

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId   String?
  organization     Organization?          @relation(fields: [organizationId], references: [id])
  sponsors         SpacSponsor[]
  targets          Target[]
  documents        Document[]
  filings          Filing[]
  financials       Financial[]
  tasks            Task[]
  trustAccounts    TrustAccount[]
  capTableEntries  CapTableEntry[]
  warrants         Warrant[]
  redemptions      Redemption[]
  pipes            PipeInvestor[]
  earnouts         Earnout[]
  milestones       Milestone[]
  complianceItems  ComplianceItem[]
  boardMeetings    BoardMeeting[]
  conflicts        Conflict[]
  insiderWindows   InsiderTradingWindow[]
  secComments      SecComment[]
  webhooks         Webhook[]
  notes            Note[]
  complianceAlerts ComplianceAlert[]

  // Sprint 12 - Target Fit Scores
  fitScores        TargetFitScore[]

  @@index([organizationId])
  @@index([status])
  @@index([ticker])
  @@map("spacs")
}

/// Target company - Potential acquisition targets for SPACs
model Target {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  industry    String?
  sector      String?
  status      TargetStatus @default(IDENTIFIED)
  stage       TargetStage?

  // Valuation
  valuation       Decimal? @db.Decimal(18, 2)
  enterpriseValue Decimal? @db.Decimal(18, 2)
  revenue         Decimal? @db.Decimal(18, 2)
  ebitda          Decimal? @db.Decimal(18, 2)
  evRevenue       Decimal? @db.Decimal(10, 2)
  evEbitda        Decimal? @db.Decimal(10, 2)

  // Scoring
  aiScore          Decimal? @db.Decimal(5, 2)
  overallScore     Decimal? @db.Decimal(5, 2)
  managementScore  Int?
  marketScore      Int?
  financialScore   Int?
  operationalScore Int?
  riskScore        Int?

  // Priority
  priority    Int      @default(0)
  probability Decimal? @db.Decimal(5, 4)

  // Due Diligence
  dueDiligenceStatus Json?
  keyRisks           String[] @default([])
  keyOpportunities   String[] @default([])

  // Key Dates
  identifiedDate    DateTime?
  ndaDate           DateTime?
  ndaSignedDate     DateTime?
  loiDate           DateTime?
  loiSignedDate     DateTime?
  daDate            DateTime?
  daSignedDate      DateTime?
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId         String?
  spac           Spac?           @relation(fields: [spacId], references: [id])
  documents      Document[]
  tasks          Task[]
  contacts       TargetContact[]
  transactions   Transaction[]
  notes          Note[]
  scoreHistories ScoreHistory[]

  // Sprint 12 - Link to Organization (type=TARGET_COMPANY) profile
  organizationId String?
  organization   Organization?   @relation("TargetOrganization", fields: [organizationId], references: [id])

  @@index([spacId])
  @@index([status])
  @@index([industry])
  @@index([organizationId])
  @@map("targets")
}

/// TargetContact - Many-to-many relationship between Targets and Contacts
model TargetContact {
  id        String  @id @default(cuid())
  role      String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  targetId  String
  target    Target  @relation(fields: [targetId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([targetId, contactId])
  @@index([targetId])
  @@index([contactId])
  @@map("target_contacts")
}

/// Transaction - Target transaction records
model Transaction {
  id          String    @id @default(cuid())
  type        String
  amount      Decimal?  @db.Decimal(18, 2)
  description String?   @db.Text
  date        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  targetId String
  target   Target @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@index([targetId])
  @@map("transactions")
}

/// Document - Files and documents related to SPACs and targets
model Document {
  id              String         @id @default(cuid())
  name            String
  type            DocumentType   @default(OTHER)
  category        String?
  status          DocumentStatus @default(DRAFT)
  fileUrl         String?
  fileSize        Int?
  mimeType        String?
  aiSummary       String?        @db.Text
  aiExtractedData Json?

  // Versioning
  version  Int        @default(1)
  parentId String?
  parent   Document?  @relation("DocumentVersions", fields: [parentId], references: [id])
  versions Document[] @relation("DocumentVersions")
  isLatest Boolean    @default(true)

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId           String?
  spac             Spac?              @relation(fields: [spacId], references: [id])
  targetId         String?
  target           Target?            @relation(fields: [targetId], references: [id])
  filings          FilingDocument[]
  documentAnalyses DocumentAnalysis[]

  @@index([spacId])
  @@index([targetId])
  @@index([type])
  @@index([parentId])
  @@index([name, spacId])
  @@index([name, targetId])
  @@map("documents")
}

/// Filing - SEC filing management (consolidated from legacy SecFiling)
model Filing {
  id          String       @id @default(cuid())
  type        FilingType
  status      FilingStatus @default(DRAFTING)
  title       String?
  description String?      @db.Text

  // SEC Details
  cik             String?
  accessionNumber String?
  fileNumber      String?
  edgarUrl        String?

  // Dates
  dueDate            DateTime?
  filedDate          DateTime?
  effectiveDate      DateTime?
  internalReviewDate DateTime?
  externalReviewDate DateTime?
  secCommentDate     DateTime?
  responseDate       DateTime?

  // Amendment tracking
  amendmentNumber Int      @default(0)
  parentFilingId  String?
  parentFiling    Filing?  @relation("FilingAmendments", fields: [parentFilingId], references: [id])
  amendments      Filing[] @relation("FilingAmendments")

  // SEC Comment tracking
  secCommentCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId      String
  spac        Spac             @relation(fields: [spacId], references: [id], onDelete: Cascade)
  secComments   SecComment[]
  documents     FilingDocument[]
  tasks         Task[]
  comments      Comment[]
  workflowSteps FilingWorkflowStep[]
  reviewers     FilingReviewer[]
  checklist     FilingChecklist[]

  @@index([spacId])
  @@index([type])
  @@index([status])
  @@index([filedDate])
  @@map("filings")
}

/// FilingDocument - Many-to-many relationship between Filings and Documents
model FilingDocument {
  id String @id @default(cuid())

  createdAt DateTime @default(now())

  // Relations
  filingId   String
  filing     Filing   @relation(fields: [filingId], references: [id], onDelete: Cascade)
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([filingId, documentId])
  @@index([filingId])
  @@index([documentId])
  @@map("filing_documents")
}

/// SecComment - SEC comment letters and responses
model SecComment {
  id            String    @id @default(cuid())
  commentNumber Int
  commentText   String    @db.Text
  category      String?
  receivedDate  DateTime
  dueDate       DateTime?
  responseText  String?   @db.Text
  responseDate  DateTime?
  isResolved    Boolean   @default(false)
  resolvedDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId   String
  spac     Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)
  filingId String
  filing   Filing @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([filingId])
  @@index([isResolved])
  @@map("sec_comments")
}

/// Comment - User comments on various entities
model Comment {
  id      String @id @default(cuid())
  content String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  filingId String?
  filing   Filing? @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([filingId])
  @@map("comments")
}

/// Contact - CRM contacts for investors, advisors, and other stakeholders
model Contact {
  id                String        @id @default(cuid())
  firstName         String
  lastName          String
  email             String?
  phone             String?
  mobile            String?
  title             String?
  type              ContactType   @default(OTHER)
  status            ContactStatus @default(ACTIVE)
  linkedIn          String?
  twitter           String?
  address           String?
  city              String?
  state             String?
  country           String?
  postalCode        String?
  avatarUrl         String?
  notes             String?       @db.Text
  tags              String[]      @default([])
  isStarred         Boolean       @default(false)
  relationshipScore Int           @default(0)
  lastInteractionAt DateTime?
  ownerId           String?

  // Organization link (Sprint 12.5 - consolidated from legacy companyId)
  organizationId       String?
  seniorityLevel       SeniorityLevel?
  relationshipStrength RelationshipStrength @default(COLD)
  dealRoles            String[]             @default([]) // e.g., ["Decision Maker", "Influencer"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner         User?             @relation("ContactOwner", fields: [ownerId], references: [id])
  organization  Organization?     @relation("OrganizationContacts", fields: [organizationId], references: [id])
  targets       TargetContact[]
  interactions  Interaction[]
  meetings      MeetingAttendee[]
  contactNotes  ContactNote[]
  emails        Email[]
  activities    ActivityFeed[]

  // Sprint 11 - IB mandate and coverage relations
  mandates      IBMandate[]       @relation("MandateContacts")
  coverageAreas IBCoverage[]      @relation("CoverageContacts")

  @@index([email])
  @@index([ownerId])
  @@index([status])
  @@index([organizationId])
  @@index([relationshipStrength])
  @@map("contacts")
}

// Company and CompanyDeal models removed in Sprint 12.5
// All company data consolidated into Organization model
// Use Organization with appropriate type (PE_FIRM, IB, TARGET_COMPANY, GENERAL, etc.)

/// Interaction - Activity log for contact interactions
model Interaction {
  id          String          @id @default(cuid())
  contactId   String
  type        InteractionType
  subject     String?
  description String?         @db.Text
  date        DateTime        @default(now())
  duration    Int?            // minutes
  outcome     String?

  createdAt   DateTime @default(now())
  createdById String?

  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("InteractionCreator", fields: [createdById], references: [id])

  @@index([contactId])
  @@index([date])
  @@map("interactions")
}

/// ContactNote - Notes attached to contacts
model ContactNote {
  id        String  @id @default(cuid())
  contactId String
  content   String  @db.Text
  isPinned  Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("ContactNoteCreator", fields: [createdById], references: [id])

  @@index([contactId])
  @@map("contact_notes")
}

/// Meeting - Scheduled meetings
model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  startTime   DateTime
  endTime     DateTime
  location    String?
  meetingUrl  String?  // Zoom/Google Meet link
  calendarId  String?  // Google Calendar event ID
  calendlyId  String?  // Calendly event ID

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  createdBy User?             @relation("MeetingCreator", fields: [createdById], references: [id])
  attendees MeetingAttendee[]

  @@index([startTime])
  @@map("meetings")
}

/// MeetingAttendee - Meeting attendees junction table
model MeetingAttendee {
  id        String                @id @default(cuid())
  meetingId String
  contactId String?
  userId    String?
  email     String?
  status    MeetingAttendeeStatus @default(PENDING)

  meeting Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])
  user    User?    @relation("MeetingAttendees", fields: [userId], references: [id])

  @@unique([meetingId, contactId])
  @@unique([meetingId, userId])
  @@map("meeting_attendees")
}

/// Email - Synced emails from Gmail
model Email {
  id        String         @id @default(cuid())
  contactId String?
  gmailId   String         @unique // Gmail message ID
  threadId  String                 // Gmail thread ID
  subject   String?
  snippet   String?                // Preview text
  body      String?        @db.Text // Full body (HTML)
  direction EmailDirection
  fromEmail String
  toEmails  String[]
  ccEmails  String[]       @default([])
  date      DateTime
  isRead    Boolean        @default(false)
  isStarred Boolean        @default(false)
  labels    String[]       @default([])

  createdAt DateTime @default(now())

  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([contactId])
  @@index([threadId])
  @@index([date])
  @@map("emails")
}

/// CalendarConnection - OAuth tokens for calendar integrations
model CalendarConnection {
  id           String    @id @default(cuid())
  userId       String    @unique
  provider     String    // "google", "calendly"
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?
  scope        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("calendar_connections")
}

/// EmailConnection - OAuth tokens for Gmail integration
model EmailConnection {
  id           String    @id @default(cuid())
  userId       String    @unique
  provider     String    // "gmail"
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?
  historyId    String?   // Gmail history ID for incremental sync

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_connections")
}

/// Task - Tasks and todos related to SPAC operations
model Task {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(NOT_STARTED)
  priority    TaskPriority @default(MEDIUM)
  category    String?
  dueDate     DateTime?
  completedAt DateTime?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId     String?
  spac       Spac?   @relation(fields: [spacId], references: [id])
  targetId   String?
  target     Target? @relation(fields: [targetId], references: [id])
  filingId   String?
  filing     Filing? @relation(fields: [filingId], references: [id])
  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creatorId  String?
  creator    User?   @relation("TaskCreator", fields: [creatorId], references: [id])

  @@index([spacId])
  @@index([targetId])
  @@index([filingId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

/// Financial - Financial records and models
model Financial {
  id     String        @id @default(cuid())
  type   FinancialType
  period String?
  data   Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id])

  @@index([spacId])
  @@index([type])
  @@map("financials")
}

/// TrustAccount - Trust account balance tracking
model TrustAccount {
  id              String   @id @default(cuid())
  accountName     String?
  currentBalance  Decimal  @db.Decimal(18, 2)
  balanceDate     DateTime
  perShareValue   Decimal? @db.Decimal(10, 4)
  accruedInterest Decimal? @db.Decimal(18, 2)
  balanceHistory  Json? // Array of historical balances

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([balanceDate])
  @@map("trust_accounts")
}

/// CapTableEntry - Cap table ownership records
model CapTableEntry {
  id           String  @id @default(cuid())
  holderName   String
  holderType   String // FOUNDER, SPONSOR, PUBLIC, PIPE, etc.
  shareClass   String // CLASS_A, CLASS_B, FOUNDER, etc.
  sharesOwned  BigInt
  ownershipPct Decimal @db.Decimal(10, 6)
  vestingInfo  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([holderType])
  @@index([shareClass])
  @@map("cap_table_entries")
}

/// Warrant - Warrant tracking
model Warrant {
  id                String      @id @default(cuid())
  type              WarrantType
  totalWarrants     BigInt
  exercisePrice     Decimal     @db.Decimal(10, 4)
  expirationDate    DateTime?
  warrantsExercised BigInt      @default(0)
  warrantsRedeemed  BigInt      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([type])
  @@map("warrants")
}

/// Redemption - Redemption event tracking
model Redemption {
  id              String   @id @default(cuid())
  eventType       String // EXTENSION, VOTE, OTHER
  eventDate       DateTime
  sharesEligible  BigInt
  sharesRedeemed  BigInt
  redemptionRate  Decimal  @db.Decimal(10, 6)
  redemptionPrice Decimal? @db.Decimal(10, 4)
  totalPayout     Decimal? @db.Decimal(18, 2)
  remainingShares BigInt?
  remainingTrust  Decimal? @db.Decimal(18, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([eventDate])
  @@map("redemptions")
}

/// PipeInvestor - PIPE investor tracking
model PipeInvestor {
  id              String     @id @default(cuid())
  investorName    String
  investorType    String? // STRATEGIC, FINANCIAL, etc.
  status          PipeStatus @default(PROSPECT)
  targetAmount    Decimal?   @db.Decimal(18, 2)
  committedAmount Decimal?   @db.Decimal(18, 2)
  fundedAmount    Decimal?   @db.Decimal(18, 2)
  commitmentDate  DateTime?
  fundingDate     DateTime?
  notes           String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([status])
  @@map("pipe_investors")
}

/// Earnout - Earnout milestone tracking
model Earnout {
  id               String        @id @default(cuid())
  name             String
  description      String?       @db.Text
  status           EarnoutStatus @default(PENDING)
  metricType       String // STOCK_PRICE, REVENUE, EBITDA, etc.
  targetValue      Decimal       @db.Decimal(18, 2)
  currentValue     Decimal?      @db.Decimal(18, 2)
  earnoutShares    BigInt
  sharesEarned     BigInt        @default(0)
  measurementStart DateTime?
  measurementEnd   DateTime?
  achievedDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([status])
  @@map("earnouts")
}

/// Milestone - Key milestones for SPAC lifecycle
model Milestone {
  id          String        @id @default(cuid())
  name        String
  description String?       @db.Text
  type        MilestoneType @default(OTHER)
  targetDate  DateTime?
  actualDate  DateTime?
  isCompleted Boolean       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([isCompleted])
  @@map("milestones")
}

// ============================================================================
// COMPLIANCE MODELS
// ============================================================================

/// ComplianceItem - Compliance requirements and tracking
model ComplianceItem {
  id            String           @id @default(cuid())
  name          String
  description   String?          @db.Text
  category      String // SEC, LEGAL, CORPORATE, etc.
  status        ComplianceStatus @default(PENDING)
  dueDate       DateTime?
  completedDate DateTime?
  assignedTo    String?
  notes         String?          @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([status])
  @@index([category])
  @@index([dueDate])
  @@map("compliance_items")
}

/// BoardMeeting - Board meeting records
model BoardMeeting {
  id             String             @id @default(cuid())
  title          String
  type           String             // REGULAR, SPECIAL, UNANIMOUS_CONSENT
  status         BoardMeetingStatus @default(SCHEDULED)
  scheduledDate  DateTime
  actualDate     DateTime?
  location       String?
  agenda         String?            @db.Text
  minutes        String?            @db.Text
  attendees      String[]           @default([])
  quorumRequired Int?
  quorumMet      Boolean?
  resolutions    Json?              // Array of resolutions with voting results

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([scheduledDate])
  @@index([status])
  @@map("board_meetings")
}

/// Conflict - Conflicts of interest tracking
model Conflict {
  id              String           @id @default(cuid())
  title           String
  description     String           @db.Text
  involvedParties String[]         @default([])
  severity        ConflictSeverity @default(MEDIUM)
  isResolved      Boolean          @default(false)
  resolution      String?          @db.Text
  resolvedDate    DateTime?
  disclosedDate   DateTime?
  disclosedIn     String? // Filing or document where disclosed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([severity])
  @@index([isResolved])
  @@map("conflicts")
}

/// InsiderTradingWindow - Insider trading window management
model InsiderTradingWindow {
  id         String              @id @default(cuid())
  name       String?
  status     TradingWindowStatus @default(OPEN)
  startDate  DateTime
  endDate    DateTime?
  reason     String?             @db.Text
  affectsAll Boolean             @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  spacId String
  spac   Spac    @relation(fields: [spacId], references: [id], onDelete: Cascade)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([spacId])
  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@map("insider_trading_windows")
}

// ============================================================================
// WEBHOOK MODELS
// ============================================================================

/// Webhook - Webhook configuration
model Webhook {
  id              String    @id @default(cuid())
  name            String
  url             String
  secret          String
  events          String[]  @default([])
  headers         Json?
  isActive        Boolean   @default(true)
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  spacId         String?
  spac           Spac?             @relation(fields: [spacId], references: [id])
  deliveries     WebhookDelivery[]

  @@index([organizationId])
  @@index([spacId])
  @@index([isActive])
  @@map("webhooks")
}

/// WebhookDelivery - Webhook delivery records
model WebhookDelivery {
  id          String    @id @default(cuid())
  eventType   String
  payload     Json
  statusCode  Int?
  response    String?   @db.Text
  error       String?   @db.Text
  duration    Int? // milliseconds
  success     Boolean   @default(false)
  attempts    Int       @default(1)
  deliveredAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([success])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

/// Organization - Multi-tenant organization for SPAC OS (enhanced for PE/IB tracking)
model Organization {
  id        String              @id @default(cuid())
  name      String
  legalName String?
  slug      String              @unique
  type      OrganizationType    @default(OTHER)
  subType   OrganizationSubType?

  // PE-specific fields
  aum            Decimal? @db.Decimal(18, 2) // Assets Under Management
  fundVintage    Int?                        // Most recent fund year
  industryFocus  String[] @default([])       // e.g., ["Healthcare", "Technology"]
  geographyFocus String[] @default([])       // e.g., ["North America", "Europe"]
  dealSizeMin    Decimal? @db.Decimal(18, 2) // Min deal size
  dealSizeMax    Decimal? @db.Decimal(18, 2) // Max deal size

  // General fields
  website       String?
  description   String?  @db.Text
  headquarters  String?
  logoUrl       String?
  foundedYear   Int?
  employeeCount Int?

  // Sprint 12 - Target Company Financial Metrics
  revenue       Decimal? @db.Decimal(18, 2) // Annual revenue
  ebitda        Decimal? @db.Decimal(18, 2) // EBITDA
  revenueGrowth Decimal? @db.Decimal(5, 2)  // Revenue growth rate (%)
  grossMargin   Decimal? @db.Decimal(5, 2)  // Gross margin (%)

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         OrganizationUser[]
  contacts      Contact[]           @relation("OrganizationContacts")
  ownedStakes   OwnershipStake[]    @relation("Owner")
  ownedByStakes OwnershipStake[]    @relation("OwnedEntity")
  activities    ActivityFeed[]
  auditLogs     AuditLog[]
  spacs         Spac[]
  webhooks      Webhook[]

  // Sprint 11 - IB-specific relations
  ibMandates    IBMandate[]         @relation("IBMandates")
  ibCoverage    IBCoverage[]        @relation("IBCoverage")

  // Sprint 12 - Target Company relations
  targets       Target[]            @relation("TargetOrganization")
  fitScores     TargetFitScore[]

  @@index([slug])
  @@index([type])
  @@index([subType])
  @@map("organizations")
}

/// OrganizationUser - User membership in an organization
model OrganizationUser {
  id     String           @id @default(cuid())
  role   OrganizationRole @default(MEMBER)
  userId String // Clerk user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_users")
}

/// AuditLog - Audit trail for tracking user actions
model AuditLog {
  id         String  @id @default(cuid())
  action     String
  entityType String
  entityId   String
  userId     String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Note - Notes attached to targets or SPACs
model Note {
  id        String   @id @default(uuid())
  content   String   @db.Text
  targetId  String?
  spacId    String?
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  target Target? @relation(fields: [targetId], references: [id], onDelete: Cascade)
  spac   Spac?   @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([targetId])
  @@index([spacId])
  @@index([createdAt])
  @@map("notes")
}

// ============================================================================
// SPRINT 6 - AI ANALYSIS MODELS
// ============================================================================

/// DocumentAnalysis - Cached AI analysis results for documents
model DocumentAnalysis {
  id                  String    @id @default(cuid())
  documentId          String
  summary             String?   @db.Text
  keyTerms            Json?
  riskFlags           Json?
  actionItems         Json?
  insights            Json?
  financialHighlights Json?
  riskLevel           String? // "high", "medium", "low", "none"
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  expiresAt           DateTime?

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([riskLevel])
  @@index([expiresAt])
  @@map("document_analyses")
}

/// ScoreHistory - Historical tracking of AI scores for targets
model ScoreHistory {
  id               String   @id @default(cuid())
  targetId         String
  overallScore     Int
  managementScore  Int?
  marketScore      Int?
  financialScore   Int?
  operationalScore Int?
  transactionScore Int?
  thesis           String?  @db.Text
  createdAt        DateTime @default(now())

  // Relations
  target Target @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@index([targetId])
  @@index([createdAt])
  @@map("score_histories")
}

/// ComplianceAlert - Compliance alerts and notifications
model ComplianceAlert {
  id          String    @id @default(cuid())
  spacId      String?
  type        String // "DEADLINE_APPROACHING", "DEADLINE_MISSED", "FILING_REQUIRED", etc.
  severity    String // "high", "medium", "low"
  title       String
  description String    @db.Text
  dueDate     DateTime?
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  spac Spac? @relation(fields: [spacId], references: [id], onDelete: Cascade)

  @@index([spacId])
  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([isDismissed])
  @@index([dueDate])
  // TD-001: Composite index for optimized alert list queries
  // Covers the common filter pattern: isDismissed + spacId + ordering columns
  @@index([isDismissed, spacId, isRead, severity, dueDate, createdAt])
  @@map("compliance_alerts")
}

// ============================================================================
// SPRINT 9 - FILING WORKFLOW MODELS
// ============================================================================

/// FilingWorkflowStep - Workflow steps for filing process
model FilingWorkflowStep {
  id            String                   @id @default(cuid())
  filingId      String
  name          String
  description   String?                  @db.Text
  status        FilingWorkflowStepStatus @default(PENDING)
  order         Int
  dueDate       DateTime?
  completedAt   DateTime?
  completedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filing Filing @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([filingId])
  @@index([status])
  @@map("filing_workflow_steps")
}

/// FilingReviewer - Assigned reviewers for filings
model FilingReviewer {
  id         String               @id @default(cuid())
  filingId   String
  userId     String?
  name       String?
  email      String?
  role       String               // "primary", "secondary", "legal", "external"
  status     FilingReviewerStatus @default(PENDING)
  comments   String?              @db.Text
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filing Filing @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([filingId])
  @@index([status])
  @@map("filing_reviewers")
}

/// FilingChecklist - Checklist items for filing preparation
model FilingChecklist {
  id          String    @id @default(cuid())
  filingId    String
  item        String
  category    String?   // "disclosure", "financial", "transaction", "exhibits", "sec_response"
  description String?   @db.Text
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  completedBy String?
  order       Int       @default(0)
  dueDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filing Filing @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([filingId])
  @@index([isCompleted])
  @@map("filing_checklists")
}

// ============================================================================
// RATE LIMITING MODELS
// ============================================================================

/// RateLimitState - Tracks rate limiter state for serverless deployments
/// Used to persist rate limiting across serverless function invocations
model RateLimitState {
  id                String   @id
  lastRequestTime   BigInt   // Unix timestamp in milliseconds
  requestCount      Int      @default(0) // Requests in current window (for future token bucket)
  windowStart       BigInt?  // Start of rate limit window (for future token bucket)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rate_limit_states")
}

// ============================================================================
// SPRINT 10 - PE FIRM MANAGEMENT MODELS
// ============================================================================

/// OwnershipStake - Tracks PE firm ownership in portfolio companies
model OwnershipStake {
  id String @id @default(cuid())

  // Owner (who owns)
  ownerId String
  owner   Organization @relation("Owner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Owned entity (what is owned)
  ownedId String
  owned   Organization @relation("OwnedEntity", fields: [ownedId], references: [id], onDelete: Cascade)

  // Ownership details
  ownershipPct   Decimal   @db.Decimal(10, 4) // Ownership percentage
  stakeType      StakeType                    // MAJORITY, MINORITY, CONTROL, etc.
  investmentDate DateTime?
  entryValuation Decimal?  @db.Decimal(18, 2) // Entry valuation
  entryMultiple  Decimal?  @db.Decimal(10, 2) // Entry EV/EBITDA multiple
  boardSeats     Int?                         // Number of board seats

  // Exit tracking
  exitWindow         DateTime?  // Expected exit date
  estimatedHoldYears Int?       // Typical hold period
  exitStatus         ExitStatus @default(ACTIVE)
  exitDate           DateTime?
  exitValuation      Decimal?   @db.Decimal(18, 2)
  exitMultiple       Decimal?   @db.Decimal(10, 2)

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, ownedId])
  @@index([ownerId])
  @@index([ownedId])
  @@index([exitStatus])
  @@map("ownership_stakes")
}

/// ActivityFeed - Unified activity timeline for organizations and contacts
model ActivityFeed {
  id String @id @default(cuid())

  // Context
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId      String?
  contact        Contact?      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])

  // Activity details
  type        ActivityType
  title       String
  description String?      @db.Text
  metadata    Json?        // Flexible storage for type-specific data

  // Reference to source record
  sourceType String? // "email", "meeting", "call", "note", "deal"
  sourceId   String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activity_feeds")
}

// ============================================================================
// SPRINT 11 - IB FIRM MANAGEMENT MODELS
// ============================================================================

/// IBMandate - Tracks IB mandates to sell/advise companies
model IBMandate {
  id                String   @id @default(cuid())

  // IB Organization
  organizationId    String
  organization      Organization @relation("IBMandates", fields: [organizationId], references: [id], onDelete: Cascade)

  // Mandate details
  clientName        String           // Company/client being advised
  serviceType       MandateServiceType
  status            MandateStatus    @default(ACTIVE)
  dealValue         Decimal?         @db.Decimal(18, 2)
  expectedFee       Decimal?         @db.Decimal(18, 2)

  // Dates
  mandateDate       DateTime?
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  // Details
  description       String?          @db.Text
  notes             String?          @db.Text

  // Relations - IB contacts working on this mandate
  contacts          Contact[]        @relation("MandateContacts")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@map("ib_mandates")
}

/// IBCoverage - Tracks IB sector/industry coverage and expertise
model IBCoverage {
  id              String   @id @default(cuid())

  organizationId  String
  organization    Organization @relation("IBCoverage", fields: [organizationId], references: [id], onDelete: Cascade)

  sector          String           // "Healthcare", "Technology", "Industrials"
  subSector       String?          // "Medical Devices", "Enterprise Software"
  geography       String?          // "North America", "Europe"

  // Coverage strength
  expertise       CoverageExpertise @default(MODERATE)

  // Key contacts for this coverage area
  contacts        Contact[]        @relation("CoverageContacts")

  notes           String?          @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, sector, subSector, geography])
  @@index([organizationId])
  @@map("ib_coverage")
}

enum MandateServiceType {
  MA_SELLSIDE       // M&A - representing seller
  MA_BUYSIDE        // M&A - representing buyer
  CAPITAL_RAISE     // Equity or debt raise
  RESTRUCTURING     // Financial restructuring
  FAIRNESS_OPINION  // Valuation/opinion
  SPAC_ADVISORY     // SPAC-specific advisory
  OTHER
}

enum MandateStatus {
  ACTIVE
  WON
  LOST
  COMPLETED
  ON_HOLD
}

enum CoverageExpertise {
  LEADING    // Top tier, many deals
  STRONG     // Well established
  MODERATE   // Some presence
  EMERGING   // Building capability
}

// ============================================================================
// SPRINT 12 - TARGET COMPANY MANAGEMENT MODELS
// ============================================================================

/// TargetFitScore - AI-powered fit scoring for target companies against SPAC criteria
model TargetFitScore {
  id              String   @id @default(cuid())

  // Links to target company (Organization type=TARGET_COMPANY) and SPAC
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  spacId          String           // Which SPAC's criteria was used
  spac            Spac             @relation(fields: [spacId], references: [id], onDelete: Cascade)

  // Scores (0-100)
  overallScore    Int              // Weighted overall fit score
  sizeScore       Int              // Revenue/EBITDA fit vs criteria
  sectorScore     Int              // Industry/sector alignment
  geographyScore  Int              // Geographic fit
  ownershipScore  Int              // Ownership complexity (PE backing, founder %)

  // AI-generated insights
  aiSummary       String?          @db.Text
  aiRecommendation String?         @db.Text

  // Audit
  calculatedAt    DateTime         @default(now())
  calculatedBy    String?          // User ID or "AI"

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([organizationId, spacId])  // One score per org+spac combo
  @@index([organizationId])
  @@index([spacId])
  @@index([overallScore])
  @@map("target_fit_scores")
}
